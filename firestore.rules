rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow server-side admin access to all documents
    allow read, write: if request.auth.token.firebase.sign_in_provider == 'custom';

    // Allow client-side read access to configuration files.
    // Deny client-side writes to prevent unauthorized changes.
    match /configurations/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    // Allow the server (via admin SDK) to write to the knowledge base metadata.
    // Deny all client-side access.
    match /kb_{level}_meta_v1/{sourceId} {
      allow read, write: if request.auth.token.firebase.sign_in_provider == 'custom';
    }

    // Allow the server (via admin SDK) to write to the knowledge base chunks.
    // This is where text is stored before being indexed by the extension.
    // Deny all client-side access.
    match /kb_chunks/{chunkId} {
       allow read, write: if request.auth.token.firebase.sign_in_provider == 'custom';
    }

    // Default deny all other collections.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}