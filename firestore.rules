rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow admin full access to configuration settings
    match /configurations/{docId} {
      allow read, write: if request.auth != null;
    }

    // Allow admin full access to all knowledge base metadata collections
    match /kb_{level}_meta_v1/{docId} {
       // Allow any user to CREATE a document in the chat history.
       // This is for the front-end client to save the transcript for processing.
       // All other operations (read, update, delete) are restricted to admins.
      allow create: if level == 'chat_history';
      allow read, update, delete: if request.auth != null;
    }
    
    // Allow admin full access to the indexed data chunks
    match /kb_chunks/{chunkId} {
      allow read, write: if request.auth != null;
    }

    // Deny all other reads/writes by default for security
    match /{document=**} {
      allow read, write: if false;
    }
  }
}