'use server';
/**
 * @fileOverview A flow to test the core text generation functionality.
 * This is a minimal test to see if we can connect to a Gemini model.
 *
 * - testTextGeneration - A function that calls the text generation model.
 * - TestTextGenerationOutput - The return type.
 */
import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import { VertexAI } from '@google-cloud/vertexai';


const TestTextGenerationOutputSchema = z.object({
  success: z.boolean().describe('Indicates if the generation was successful.'),
  error: z.string().optional().describe('An error message if the test failed.'),
  generatedText: z.string().optional().describe('The text generated by the model.'),
});
export type TestTextGenerationOutput = z.infer<typeof TestTextGenerationOutputSchema>;

export async function testTextGeneration(): Promise<TestTextGenerationOutput> {
  return testTextGenerationFlow();
}

const testTextGenerationFlow = ai.defineFlow(
  {
    name: 'testTextGenerationFlow',
    inputSchema: z.void(),
    outputSchema: TestTextGenerationOutputSchema,
  },
  async () => {
    try {
      const projectId = process.env.GCLOUD_PROJECT || process.env.GOOGLE_CLOUD_PROJECT;
      if (!projectId) {
        throw new Error('Google Cloud Project ID not found in environment variables. This is required for server-side authentication with Vertex AI.');
      }
      
      const vertex_ai = new VertexAI({ project: projectId, location: 'us-central1' });
      const model = vertex_ai.getGenerativeModel({
          model: 'gemini-1.5-flash-001',
      });
      
      const result = await model.generateContent({
          contents: [{ role: 'user', parts: [{ text: 'Tell me a one-sentence joke.' }] }]
      });

      const text = result.response.candidates?.[0]?.content?.parts?.[0]?.text;

      if (text) {
        return {
          success: true,
          generatedText: text,
        };
      } else {
        const fullResponse = JSON.stringify(result, null, 2);
        return {
          success: false,
          error: `The text generation service returned a successful but empty response. Full response: ${fullResponse}`,
        };
      }
    } catch (e: any) {
      console.error('[testTextGenerationFlow] Full exception object caught:', JSON.stringify(e, Object.getOwnPropertyNames(e), 2));
      const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
      return {
          success: false,
          error: `The test failed. This often points to a Google Cloud project configuration issue. Please check your IAM permissions and enabled APIs as described in the README file. Full technical error: ${errorMessage}`,
      };
    }
  }
);
