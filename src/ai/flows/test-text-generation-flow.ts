'use server';
/**
 * @fileOverview A flow to test the core text generation functionality.
 * This is a minimal test to see if we can connect to a Gemini model.
 *
 * - testTextGeneration - A function that calls the text generation model.
 * - TestTextGenerationOutput - The return type.
 */
import { ai } from '@/ai/genkit';
import { z } from 'zod';


const TestTextGenerationOutputSchema = z.object({
  success: z.boolean().describe('Indicates if the generation was successful.'),
  error: z.string().optional().describe('An error message if the test failed.'),
  generatedText: z.string().optional().describe('The text generated by the model.'),
});
export type TestTextGenerationOutput = z.infer<typeof TestTextGenerationOutputSchema>;

const testTextGenerationFlow = ai.defineFlow(
  {
    name: 'testTextGenerationFlow',
    inputSchema: z.void(),
    outputSchema: TestTextGenerationOutputSchema,
  },
  async () => {
    try {
      const { text } = await ai.generate({
          model: 'googleai/gemini-1.5-flash',
          prompt: 'Tell me a one-sentence joke.',
      });

      if (text) {
        return {
          success: true,
          generatedText: text,
        };
      } else {
        return {
          success: false,
          error: `The text generation service returned a successful but empty response.`,
        };
      }
    } catch (e: any) {
      console.error('[testTextGenerationFlow] Full exception object caught:', JSON.stringify(e, Object.getOwnPropertyNames(e), 2));
      const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
      return {
          success: false,
          error: `The test failed. This often points to an issue with your GOOGLE_AI_API_KEY or project configuration. Full technical error: ${errorMessage}`,
      };
    }
  }
);
  
export async function testTextGeneration(): Promise<TestTextGenerationOutput> {
  return testTextGenerationFlow();
}
